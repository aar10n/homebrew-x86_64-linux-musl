name: Build Bottles

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version tag (e.g., 12.1.0 or 13.4.2-osdev)"
        required: true
        type: string
      arch:
        description: "Target macOS architecture"
        required: false
        default: arm64
        type: choice
        options:
          - arm64
          - intel

permissions:
  contents: write

jobs:
  build-bottles:
    name: Build bottle
    runs-on: ${{ inputs.arch == 'intel' && 'macos-13' || 'macos-14' }}

    steps:
      - name: Checkout tap repository
        uses: actions/checkout@v4

      - name: Determine build parameters
        id: prepare
        env:
          VERSION_TAG: ${{ inputs.version }}
          ARCH: ${{ inputs.arch }}
        run: |
          # Extract GCC major version (first number)
          GCC_MAJOR=$(echo "$VERSION_TAG" | grep -oE '^[0-9]+' | head -1)

          # Check for variant suffix in version tag
          if [[ "$VERSION_TAG" == *"-osdev" ]]; then
            VARIANT_SUFFIX="-osdev"
            VERSIONED_FORMULA="x86_64-linux-musl-toolchain-osdev@${GCC_MAJOR}"
          else
            VARIANT_SUFFIX=""
            VERSIONED_FORMULA="x86_64-linux-musl-toolchain@${GCC_MAJOR}"
          fi

          # Determine runner/bottle tag based on architecture
          if [[ "$ARCH" == "intel" ]]; then
            # macos-13 is Intel Ventura
            BOTTLE_TAG="ventura"
            PLATFORM_LABEL="x86_64_ventura"
          else
            BOTTLE_TAG="arm64_sonoma"
            PLATFORM_LABEL="arm64_sonoma"
          fi

          echo "versioned_formula=${VERSIONED_FORMULA}" >> $GITHUB_OUTPUT
          echo "variant_suffix=${VARIANT_SUFFIX}" >> $GITHUB_OUTPUT
          echo "gcc_major=${GCC_MAJOR}" >> $GITHUB_OUTPUT
          echo "bottle_tag=${BOTTLE_TAG}" >> $GITHUB_OUTPUT
          echo "platform_label=${PLATFORM_LABEL}" >> $GITHUB_OUTPUT

          echo "Formula: ${VERSIONED_FORMULA}"
          echo "Variant: ${VARIANT_SUFFIX:-official musl}"
          echo "Platform: ${PLATFORM_LABEL}"

      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@master

      - name: Install build dependencies
        run: |
          brew install gcc@14 wget coreutils texinfo gettext || true

          # Retry texinfo post-install if it failed
          brew postinstall texinfo 2>/dev/null || true

          # Ensure texinfo is in PATH
          export PATH="$(brew --prefix texinfo)/bin:$PATH"

          # Verify makeinfo is available
          which makeinfo
          makeinfo --version

      - name: Create versioned formula for building
        env:
          VERSION_TAG: ${{ inputs.version }}
          VERSIONED_FORMULA: ${{ steps.prepare.outputs.versioned_formula }}
          VARIANT_SUFFIX: ${{ steps.prepare.outputs.variant_suffix }}
          GCC_MAJOR: ${{ steps.prepare.outputs.gcc_major }}
          BOTTLE_TAG: ${{ steps.prepare.outputs.bottle_tag }}
        run: |
          # Download source tarball to calculate SHA256
          wget -q "https://github.com/aar10n/x86_64-linux-musl/archive/refs/tags/${VERSION_TAG}.tar.gz"
          export SOURCE_SHA256=$(shasum -a 256 "${VERSION_TAG}.tar.gz" | awk '{print $1}')
          rm "${VERSION_TAG}.tar.gz"

          # Convert formula class name to match Homebrew's conventions
          # x86_64-linux-musl-toolchain@12 -> X8664LinuxMuslToolchainAT12
          # x86_64-linux-musl-toolchain-osdev@12 -> X8664LinuxMuslToolchainOsdevAT12
          # @ becomes AT in the class name
          if [[ "$VARIANT_SUFFIX" == "-osdev" ]]; then
            export FORMULA_CLASS="X8664LinuxMuslToolchainOsdevAT${GCC_MAJOR}"
          else
            export FORMULA_CLASS="X8664LinuxMuslToolchainAT${GCC_MAJOR}"
          fi

          # Bottle SHA will be calculated later, use placeholder for now
          export BOTTLE_SHA256="0000000000000000000000000000000000000000000000000000000000000000"
          export BOTTLE_TAG="${BOTTLE_TAG}"

          # Create versioned formula from template
          VERSIONED_FILE="Formula/${VERSIONED_FORMULA}.rb"
          envsubst '$FORMULA_CLASS $VERSION_TAG $SOURCE_SHA256 $BOTTLE_SHA256 $BOTTLE_TAG' < formula-versioned.rb > "$VERSIONED_FILE"

          echo "Created versioned formula: $VERSIONED_FILE"
          cat "$VERSIONED_FILE" | head -15

          # Commit the formula so it's in the repo for tapping
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "$VERSIONED_FILE"
          git commit -m "temp: add ${VERSIONED_FORMULA} for bottle building"

      - name: Build toolchain in bottle mode
        id: build
        continue-on-error: true
        env:
          VERSIONED_FORMULA: ${{ steps.prepare.outputs.versioned_formula }}
          HOMEBREW_NO_INSTALLED_DEPENDENTS_CHECK: 1
          HOMEBREW_NO_AUTO_UPDATE: 1
          HOMEBREW_MAKE_JOBS: 1
        run: |
          # Ensure texinfo/makeinfo is in PATH for the build
          export PATH="$(brew --prefix texinfo)/bin:$PATH"
          export PATH="$(brew --prefix bison)/bin:$PATH"

          # setup-homebrew already created a symlink for our tap, so we can use it directly
          # List all formulas in the tap to verify
          brew search aar10n/x86_64-linux-musl/ || true
          ls -la "/opt/homebrew/Library/Taps/aar10n/homebrew-x86_64-linux-musl/Formula/"

          # Now build the bottle (use full tap/formula syntax)
          brew install --build-bottle --verbose "aar10n/x86_64-linux-musl/${VERSIONED_FORMULA}"

      - name: Display build logs on failure
        if: steps.build.outcome == 'failure'
        env:
          VERSIONED_FORMULA: ${{ steps.prepare.outputs.versioned_formula }}
        run: |
          echo "=== Build failed. Displaying full logs ==="
          LOG_FILE=$(ls -t ~/Library/Logs/Homebrew/${VERSIONED_FORMULA}/*.log 2>/dev/null | head -1)
          if [ -n "$LOG_FILE" ]; then
            echo "Full log from: $LOG_FILE"
            cat "$LOG_FILE"
          else
            echo "No log file found"
          fi
          exit 1

      - name: Run tests
        env:
          VERSIONED_FORMULA: ${{ steps.prepare.outputs.versioned_formula }}
        run: |
          # Formula tests use full paths, so this should work
          brew test ${VERSIONED_FORMULA}

          # For additional tests, add keg to PATH since it's keg-only
          export PATH="$(brew --prefix ${VERSIONED_FORMULA})/bin:$PATH"

          x86_64-linux-musl-gcc --version
          echo "int main() { return 0; }" | x86_64-linux-musl-gcc -x c -static - -o test
          file test
          rm test

      - name: Create bottle
        id: bottle
        env:
          VERSIONED_FORMULA: ${{ steps.prepare.outputs.versioned_formula }}
          BOTTLE_TAG: ${{ steps.prepare.outputs.bottle_tag }}
        run: |
          ROOT_URL="https://github.com/${{ github.repository }}/releases/download/${{ inputs.version }}"
          brew bottle --json --root-url="${ROOT_URL}" ${VERSIONED_FORMULA}

          BOTTLE_FILE=$(ls ${VERSIONED_FORMULA}--*.bottle*.tar.gz)
          BOTTLE_JSON=$(ls ${VERSIONED_FORMULA}--*.bottle.json)

          echo "bottle_file=${BOTTLE_FILE}" >> $GITHUB_OUTPUT
          echo "bottle_json=${BOTTLE_JSON}" >> $GITHUB_OUTPUT

          # Extract SHA256 from JSON - the key might be the formula name or have version suffix
          SHA256=$(python3 -c "import json; data = json.load(open('${BOTTLE_JSON}')); key = list(data.keys())[0]; print(data[key]['bottle']['tags']['${BOTTLE_TAG}']['sha256'])")
          echo "sha256=${SHA256}" >> $GITHUB_OUTPUT

          SIZE=$(du -h "${BOTTLE_FILE}" | cut -f1)
          echo "size=${SIZE}" >> $GITHUB_OUTPUT

          echo "âœ… Built bottle: ${BOTTLE_FILE} (${SIZE})"
          echo "SHA256: ${SHA256}"

      - name: Upload bottle as artifact
        uses: actions/upload-artifact@v4
        with:
          name: bottle-${{ steps.prepare.outputs.platform_label }}
          path: |
            ${{ steps.bottle.outputs.bottle_file }}
            ${{ steps.bottle.outputs.bottle_json }}
          retention-days: 30

      - name: Save bottle metadata
        run: |
          cat > bottle-info-${{ steps.prepare.outputs.platform_label }}.json << EOF
          {
            "platform": "${{ steps.prepare.outputs.platform_label }}",
            "sha256": "${{ steps.bottle.outputs.sha256 }}",
            "filename": "${{ steps.bottle.outputs.bottle_file }}",
            "size": "${{ steps.bottle.outputs.size }}"
          }
          EOF

      - name: Upload metadata
        uses: actions/upload-artifact@v4
        with:
          name: metadata-${{ steps.prepare.outputs.platform_label }}
          path: bottle-info-${{ steps.prepare.outputs.platform_label }}.json
          retention-days: 30

      - name: Create summary
        env:
          VERSIONED_FORMULA: ${{ steps.prepare.outputs.versioned_formula }}
          VARIANT_SUFFIX: ${{ steps.prepare.outputs.variant_suffix }}
          PLATFORM_LABEL: ${{ steps.prepare.outputs.platform_label }}
        run: |
          {
            echo "# ðŸ¾ Bottle Built"
            echo ""
            echo "**Version:** ${{ inputs.version }}"
            echo "**Variant:** ${VARIANT_SUFFIX:-official musl}"
            echo "**Platform:** ${PLATFORM_LABEL}"
            echo ""
            echo "Bottle has been uploaded as a workflow artifact."
            echo "Run the 'Publish Bottles' workflow to publish it to a release."
          } >> $GITHUB_STEP_SUMMARY
